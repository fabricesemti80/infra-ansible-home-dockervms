- name: DEPLOY Prowlarr
  block:
  - name: Create Prowlarr Data Directory
    ansible.builtin.file:
      path: "{{ item }}"
      state: directory
    with_items:
    - "{{ prowlarr_data_directory }}"

  - name: Prowlarr
    community.docker.docker_container:
      name: "{{ prowlarr_container_name }}"
      image: "{{ prowlarr_image_name }}:{{ prowlarr_image_version }}"
      pull: true
      volumes:
      - "{{ prowlarr_data_directory }}:/config:rw"
      ports:
      - "{{ prowlarr_port }}:9696"
      env:
        TZ: "{{ ansible_nas_timezone }}"
        PUID: "{{ prowlarr_user_id }}"
        PGID: "{{ prowlarr_group_id }}"
      restart_policy: unless-stopped
      memory: "{{ prowlarr_memory }}"
      networks:
        - name: "{{ docker_network }}"
      labels:
        traefik.enable: "{{ prowlarr_available_externally | string }}"
        traefik.http.routers.prowlarr.rule: "Host(`{{ prowlarr_hostname }}.{{ ansible_nas_domain }}`)"
        traefik.http.routers.prowlarr.tls.certresolver: "letsencrypt"
        traefik.http.routers.prowlarr.tls.domains[0].main: "{{ ansible_nas_domain }}"
        traefik.http.routers.prowlarr.tls.domains[0].sans: "*.{{ ansible_nas_domain }}"
        traefik.http.services.prowlarr.loadbalancer.server.port: "9696"
        homepage.group: "Download Tools"
        homepage.name: Prowlarr
        homepage.icon: sh-prowlarr
        homepage.href: "http://{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}:{{ prowlarr_port }}"
        homepage.description: Indexer Proxy

  - name: Get Prowlarr API key
    ansible.builtin.command: grep '<ApiKey>' "{{ prowlarr_data_directory }}/config.xml"
    register: prowlarr_api_key_raw
    changed_when: false

  - name: Set Prowlarr API key variable
    ansible.builtin.set_fact:
      prowlarr_api_key: "{{ prowlarr_api_key_raw.stdout | regex_replace('<ApiKey>(.*)</ApiKey>', '\\1') }}"

  - name: Display Prowlarr API key
    ansible.builtin.debug:
      msg: "Prowlarr API Key: {{ prowlarr_api_key }}"
  when: prowlarr_enabled is true


- name: REMOVE Prowlarr
  block:
  - name: Stop Prowlarr
    community.docker.docker_container:
      name: "{{ prowlarr_container_name }}"
      state: absent

  - name: Remove Prowlarr Data Directory
    ansible.builtin.file:
      path: "{{ prowlarr_data_directory }}"
      state: absent
  when: prowlarr_enabled is false
